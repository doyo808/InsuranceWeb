<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보험 상품 가입</title>
    <style>
        /* 기본 스타일링 */
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f4f7f9;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background-color: #005a9c;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        .content {
            padding: 25px;
        }
        h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            color: #005a9c;
        }

        /* 상품 정보 섹션 */
        .product-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .product-info img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        .product-info-text h3 {
            margin: 0 0 5px 0;
            font-size: 1.4em;
        }
        .product-info-text p {
            margin: 0;
            color: #666;
            font-size: 0.95em;
        }

        /* 담보(특약) 목록 섹션 */
        .coverage-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .coverage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .coverage-item:hover {
            border-color: #005a9c;
            box-shadow: 0 2px 8px rgba(0, 90, 156, 0.1);
        }
        .coverage-details {
            flex-grow: 1;
        }
        .coverage-details strong {
            font-size: 1.1em;
        }
        .coverage-details .tag {
            background-color: #e0e0e0;
            color: #555;
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: bold;
        }
        .coverage-details .tag-required {
            background-color: #ffcdd2;
            color: #c62828;
        }
        .coverage-details p {
            font-size: 0.9em;
            color: #777;
            margin: 5px 0 0 0;
        }
        .coverage-action {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .coverage-premium {
            font-weight: bold;
            font-size: 1.1em;
            color: #005a9c;
        }
        /* 커스텀 체크박스 */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #007bff;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        input:disabled + .slider {
            background-color: #e9e9e9;
            cursor: not-allowed;
        }

        /* 총 보험료 및 제출 버튼 */
        .total-summary {
            margin-top: 30px;
            padding: 20px;
            background-color: #f0f8ff;
            border: 1px solid #b3e0ff;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-summary span {
            font-size: 1.2em;
            font-weight: bold;
        }
        #total-premium {
            font-size: 1.6em;
            color: #d9534f;
            font-weight: bold;
        }
        #submit-btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #submit-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>보험 상품 가입</h1>
        </div>
        <div class="content">
            <form id="insurance-form">
				<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
				<input type="hidden" th:name="_csrf_header" th:value="${_csrf.headerName}">
                <section id="product-section">
                    <h2>가입 상품 정보</h2>
                    <div class="product-info">
                        <img src="https://via.placeholder.com/150/005a9c/FFFFFF?text=CAR" alt="자동차 보험 이미지">
                        <div class="product-info-text">
                            <h3 id="product-name">자동차 종합보험</h3>
                            <p id="product-desc">자동차 사고 시 발생하는 손해와 상해를 보장하는 종합보험 상품입니다.</p>
                            <input type="hidden" id="product-id" value="1">
                        </div>
                    </div>
                </section>

                <section id="coverage-section">
                    <h2>담보 선택</h2>
                    <ul id="coverage-list" class="coverage-list">
                        </ul>
                </section>

                <div class="total-summary">
                    <span>최종 월 보험료</span>
                    <span id="total-premium">0 원</span>
                </div>

                <button type="submit" id="submit-btn">가입하기</button>
            </form>
        </div>
    </div>

    <script>
        // DOM이 로드된 후 스크립트 실행
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DB 데이터 시뮬레이션 (원래는 서버에서 fetch) ---
            const insuranceProduct = {
                product_id: 1,
                product_name: '자동차 종합보험',
                product_desc: '자동차 사고 시 발생하는 손해와 상해를 보장하는 종합보험 상품입니다.',
                thumbnail_url: 'https://via.placeholder.com/150/005a9c/FFFFFF?text=CAR'
            };

            const coverageDefinitions = [
                { coverage_id: 101, product_id: 1, cover_name: '대인배상 I', base_premium: 30000, coverage_amount: 100000000, cover_required: 'Y', cover_desc: '자동차 사고로 타인의 신체에 피해를 입힌 경우 보장' },
                { coverage_id: 102, product_id: 1, cover_name: '대물배상', base_premium: 20000, coverage_amount: 50000000, cover_required: 'Y', cover_desc: '자동차 사고로 타인의 재물에 피해를 입힌 경우 보장' },
                { coverage_id: 103, product_id: 1, cover_name: '자기신체사고', base_premium: 15000, coverage_amount: 30000000, cover_required: 'N', cover_desc: '운전자 본인 및 가족의 신체 손해를 보장' },
                // 다른 상품의 담보 (테스트용)
                { coverage_id: 201, product_id: 2, cover_name: '화재손해', base_premium: 10000, cover_required: 'Y', cover_desc: '화재로 인한 재산 피해 보장' }
            ];

            // --- 전역 변수 및 요소 가져오기 ---
            const currentProductId = parseInt(document.getElementById('product-id').value);
            const coverageListElement = document.getElementById('coverage-list');
            const totalPremiumElement = document.getElementById('total-premium');
            const insuranceForm = document.getElementById('insurance-form');

            // --- 함수 정의 ---

            /**
             * 숫자 포맷팅 (예: 30000 -> 30,000)
             */
            const formatCurrency = (number) => {
                return new Intl.NumberFormat('ko-KR').format(number);
            };

            /**
             * 선택된 담보를 기반으로 총 보험료 계산 및 화면 업데이트
             */
            const calculateTotalPremium = () => {
                let total = 0;
                // 화면에 있는 모든 담보 체크박스를 가져옴
                const selectedCheckboxes = document.querySelectorAll('.coverage-checkbox:checked');
                
                selectedCheckboxes.forEach(checkbox => {
                    // data-* 속성에서 보험료 값을 읽어와 숫자로 변환
                    total += parseInt(checkbox.dataset.premium, 10);
                });
                
                // 화면에 총 보험료 업데이트
                totalPremiumElement.textContent = `${formatCurrency(total)} 원`;
            };

            /**
             * 상품 ID에 맞는 담보 목록을 화면에 렌더링
             */
            const renderCoverages = (productId) => {
                // 현재 상품 ID와 일치하는 담보만 필터링
                const relevantCoverages = coverageDefinitions.filter(cov => cov.product_id === productId);
                
                // 필터링된 담보 목록을 HTML로 변환하여 삽입
                coverageListElement.innerHTML = relevantCoverages.map(cov => {
                    const isRequired = cov.cover_required === 'Y';
                    return `
                        <li class="coverage-item">
                            <div class="coverage-details">
                                <strong>${cov.cover_name}</strong>
                                <span class="tag ${isRequired ? 'tag-required' : ''}">${isRequired ? '필수' : '선택'}</span>
                                <p>${cov.cover_desc}</p>
                            </div>
                            <div class="coverage-action">
                                <span class="coverage-premium">+ ${formatCurrency(cov.base_premium)} 원</span>
                                <label class="switch">
                                    <input type="checkbox" 
                                           class="coverage-checkbox" 
                                           data-coverage-id="${cov.coverage_id}" 
                                           data-coverage-name="${cov.cover_name}"
                                           data-premium="${cov.base_premium}"
										   data-amount="${cov.coverage_amount}"
                                           ${isRequired ? 'checked disabled' : ''}>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </li>
                    `;
                }).join('');

                // 렌더링 후 이벤트 리스너 추가
                addEventListenersToCoverages();
            };

            /**
             * 각 담보 체크박스에 이벤트 리스너 추가
             */
            const addEventListenersToCoverages = () => {
                const checkboxes = document.querySelectorAll('.coverage-checkbox');
                checkboxes.forEach(checkbox => {
                    // 체크박스 상태가 변경될 때마다 보험료 재계산
                    checkbox.addEventListener('change', calculateTotalPremium);
                });
            };

            /**
             * 폼 제출 시 데이터 처리 및 세션 스토리지에 저장
             */
            const handleFormSubmit = async (event) => {
                // 폼의 기본 제출 동작(새로고침) 방지
                event.preventDefault();

                // 세션에 저장할 데이터 구성
                const selectedCoverages = [];
                document.querySelectorAll('.coverage-checkbox:checked').forEach(cb => {
                    selectedCoverages.push({
                        id: parseInt(cb.dataset.coverageId),
                        name: cb.dataset.coverageName,
                        premium: parseInt(cb.dataset.premium),
						amount: parseInt(cb.dataset.amount)
                    });
                });
                
                const finalPremiumText = totalPremiumElement.textContent; // "30,000 원"
                const finalPremium = parseInt(finalPremiumText.replace(/[^0-9]/g, ''), 10); // 30000

                const submissionData = {
                    productId: currentProductId,
                    productName: insuranceProduct.product_name,
                    selectedCoverages: selectedCoverages,
                    totalPremium: finalPremium
                };

                // 객체를 JSON 문자열로 변환하여 세션 스토리지에 저장 (이는 서버에 기록되지않고, 사용자측에서만 사용함)
                // sessionStorage.setItem('insuranceSelection', JSON.stringify(sessionData));

                // alert('선택하신 정보가 세션에 저장되었습니다.\n개발자 도구(F12) > Application > Session Storage에서 확인해보세요.');
				const token = document.querySelector('input[name="_csrf"]').value;  
				const header = document.querySelector('input[name="_csrf_header"]').value;  
				try {
				        // 1. fetch API를 사용해 URL로 POST 요청을 보냅니다.
				        const response = await fetch('/kdInsuranceTeam/mall2/init', {
				            method: 'POST', // HTTP 요청 방식
				            headers: {
				                // 우리가 보내는 데이터가 JSON 형식임을 서버에 알림
				                'Content-Type': 'application/json',
								[header]: token
				            },
				            // 2. JavaScript 객체를 JSON 문자열로 변환하여 요청 본문에 담아 보냅니다.
				            body: JSON.stringify(submissionData) 
				        });

				        if (response.ok) {
				            // 3. 서버가 성공적으로 처리하고 다음 페이지로 이동하라고 알려주면
				            //    예를 들어 '/apply/confirm' 같은 확인 페이지로 이동합니다.
				            console.log('서버에 데이터 전송 성공!');
				            window.location.href = '/kdInsuranceTeam/mall2/info';
				        } else {
				            // 서버에서 오류가 발생한 경우
				            alert('신청 처리 중 오류가 발생했습니다.');
				        }
				    } catch (error) {
				        console.error('전송 실패:', error);
				        alert('서버와 통신할 수 없습니다.');
				    }
            };


            // --- 메인 로직 실행 ---
            renderCoverages(currentProductId); // 페이지 로드 시 담보 목록 렌더링
            calculateTotalPremium(); // 초기 보험료 계산 (필수 항목 기준)
            insuranceForm.addEventListener('submit', handleFormSubmit); // 폼 제출 이벤트 리스너 등록

        });
    </script>
</body>
</html>