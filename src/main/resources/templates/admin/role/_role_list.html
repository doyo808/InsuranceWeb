<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/admin/common/layout}">

<head>
    <meta charset="utf-8" />
    <title>권한목록</title>
</head>

<body>
<main layout:fragment="adminContent" class="admin-main">

    <h1>권한편집소</h1>
    
    <table border="1" style="border-collapse: collapse; width: 100%;">
        <thead>
            <tr>
                <th>선택</th>
                <th>권한번호</th>
                <th>권한코드</th>
                <th>권한설명</th>
                <th>작업</th>
            </tr>
        </thead>
        <tbody>
            <!-- 기존 권한 리스트: 수정 가능 -->
            <tr th:each="role : ${roles}">
                <form th:action="@{/admin/role/save}" method="post">
                    <td><input type="checkbox" name="selected_role_ids" th:value="${role.role_id}"></td>
                    <td th:text="${role.role_id}"></td>
                    <td><input type="text" name="role_name" th:value="${role.role_name}" /></td>
                    <td><input type="text" name="role_desc" th:value="${role.role_desc}" /></td>
                    <td>
                        <input type="hidden" name="role_id" th:value="${role.role_id}" />
                        <button type="submit">수정/저장</button>
                    </td>
                </form>
            </tr>

            <!-- 새 권한 추가용 row -->
            <tr>
                <form th:action="@{/admin/role/add}" method="post">
                    <td></td>
                    <td><input type="text" placeholder="권한번호 자동입력" readonly></td>
                    <td><input type="text" name="role_name" placeholder="권한코드 입력"></td>
                    <td><input type="text" name="role_desc" placeholder="권한설명 입력"></td>
                    <td>
                        <button type="submit">추가</button>
                    </td>
                </form>
            </tr>
        </tbody>
    </table>

    <br/>

    <!-- 숨겨진 삭제 form -->
    <form id="deleteForm" th:action="@{/admin/role/deleteAll}" method="post">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
    </form>

    <!-- 선택 삭제 버튼 -->
    <button type="button" onclick="deleteSelectedRoles()">선택 삭제</button>

    <br/><br/>
    <a th:href="@{/admin/role/main}">메인으로</a>

    <script>
    function deleteSelectedRoles() {
        // 체크된 체크박스 가져오기
        const checkboxes = document.querySelectorAll('input[name="selected_role_ids"]:checked');
        if (checkboxes.length === 0) {
            alert('삭제할 권한을 선택해주세요.');
            return;
        }

        const form = document.getElementById('deleteForm');

        // 기존 hidden input 삭제
        form.querySelectorAll('input[name="selected_role_ids"]').forEach(el => el.remove());

        // 체크된 ID를 hidden input으로 추가
        checkboxes.forEach(cb => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'selected_role_ids';
            hidden.value = cb.value;
            form.appendChild(hidden);
        });

        // submit
        form.submit();
    }
    </script>

</main>
</body>
</html>
