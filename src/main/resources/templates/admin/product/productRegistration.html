<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/admin/common/layout}">

<head>
	<meta charset="utf-8" />
	<meta name="_csrf" th:content="${_csrf.token}">
	<meta name="_csrf_header" th:content="${_csrf.headerName}">

	<title>보험 상품 등록</title>

	<!-- 페이지 전용 CSS -->
	<th:block layout:fragment="extraHead">
		<link rel="stylesheet" th:href="@{/admin/css/product-form.css}" />
	</th:block>
</head>

<body>
	<main layout:fragment="adminContent" class="admin-main">
		<form method="post" id="insurance-form" th:action="@{/admin/product}" th:object="${productForm}">
			<h1 class="page-title">보험 상품 등록</h1>
			<p class="page-desc">신규 보험 상품의 기본정보, 판매정보, 보장내용을 입력하고 약관/이미지를 첨부합니다.</p>

			<!-- 기본 정보 -->
			<section class="card card--padded product-form__section">
				<h2 class="section__title">기본 정보</h2>
				<div class="form-grid">
					<div class="field">
						<label class="field__label">상품명</label>
						<input class="field__control" type="text" name="product_name" placeholder="예) 다이렉트 자동차보험 표준형"
							required />
					</div>

					<div class="field">
						<label class="field__label">상품 설명</label>
						<textarea class="field__control" type="text" name="product_desc" placeholder="상품 설명"></textarea>
					</div>

					<div class="field">
						<label class="field__label">상품 유형</label>
						<select class="field__control">
							<option>선택하세요</option>
							<option>자동차</option>
							<option>운전자</option>
							<option>화재</option>
							<option>여행자</option>
							<option>암</option>
							<option>연금</option>
							<option>반려동물</option>
							<option>기타</option>
						</select>
					</div>

					<div class="field">
						<label class="field__label">판매 상태</label>
						<select class="field__control">
							<option>판매중</option>
							<option>판매종료</option>
							<option>준비중</option>
						</select>
					</div>
				</div>
			</section>

			<!-- 판매/기간 정보 -->
			<section class="card card--padded product-form__section">
				<h2 class="section__title">담보 목록(1개이상 필수)</h2>
				<div>
					<div id="coverage-list">
						<!-- 여기에 행이 추가됩니다 -->
					</div>

					<!-- 템플릿 (숨김 처리) -->
					<template id="coverage-template">
						<div class="coverage-row"
							style="border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin: 8px 0;">
							<div class="form-grid form-grid--2">
								<div class="field">
									<label class="field__label">담보명</label>
									<input class="field__control cover-name" type="text" placeholder="예: 대인배상Ⅰ"
										required>
								</div>
								<div class="field">
									<label class="field__label">보장 보험금</label>
									<input class="field__control cover-amount" type="number" placeholder="예: 10000000">
								</div>
								<div class="field">
									<label class="field__label">기본 보험료</label>
									<input class="field__control cover-premium" type="number" placeholder="예: 5000">
								</div>
								<div class="field">
									<label class="field__label">필수 담보</label>
									<select class="field__control cover-required">
										<option value="Y">필수</option>
										<option value="N">선택</option>
									</select>
								</div>
							</div>

							<div class="field">
								<label class="field__label">담보 설명</label>
								<textarea class="field__control cover-desc" placeholder="담보 설명 입력"></textarea>
							</div>

							<button type="button" class="btn" onclick="this.parentElement.remove()">제거</button>
						</div>
					</template>


					<button type="button" class="btn" onclick="addCoverage()">담보 추가</button>
				</div>
			</section>

			<!-- 보험요율 -->
			<section class="card card--padded product-form__section">
				<h2 class="section__title">보험료율 (1개 이상 필수)</h2>
				<div id="rate-list">
					<!-- 여기에 행이 추가됨 -->
				</div>

				<!-- 요율 템플릿-->
				<template id="rate-template">
					<div class="rate-row"
						style="border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin: 8px 0;">
						<div class="form-grid form-grid--3">
							<div class="field">
								<label class="field__label">나이 From</label>
								<input class="field__control age-from" type="number" placeholder="예: 20" />
							</div>
							<div class="field">
								<label class="field__label">나이 To</label>
								<input class="field__control age-to" type="number" placeholder="예: 29" />
							</div>
							<div class="field">
								<label class="field__label">성별</label>
								<select class="field__control gender">
									<option value="M">남</option>
									<option value="F">여</option>
								</select>
							</div>
							<div class="field">
								<label><input type="checkbox" class="smoker" /> 흡연자</label>
							</div>
							<div class="field">
								<label class="field__label">나이 가중치</label>
								<input class="field__control age-weight" type="number" step="0.01" />
							</div>
							<div class="field">
								<label class="field__label">성별 가중치</label>
								<input class="field__control gender-weight" type="number" step="0.01" />
							</div>
						</div>
						<button type="button" class="btn" onclick="this.parentElement.remove()">제거</button>
					</div>
				</template>

				<button type="button" class="btn" onclick="addRate()">요율 추가</button>
			</section>

			<!-- 첨부 파일 -->
			<section class="card card--padded product-form__section">
				<h2 class="section__title">첨부 파일</h2>
				<div class="form-grid form-grid--2">
					<div class="field">
						<label class="field__label">상품 약관 (PDF)</label>
						<input class="field__control" type="file" name="conditions" accept=".pdf" />
						<ul class="file-hints">
							<li>최대 10MB, PDF만 업로드 가능</li>
						</ul>
					</div>
					<div class="field">
						<label class="field__label">대표 이미지 (JPG/PNG)</label>
						<input class="field__control" type="file" name="thumbnail" accept=".jpg,.jpeg,.png" />
						<ul class="file-hints">
							<li>권장 크기: 1200×630, 최대 5MB</li>
						</ul>
					</div>
				</div>
				<div class="preview">
					<div class="preview__img" aria-label="이미지 미리보기">이미지 미리보기</div>
					<div class="preview__meta">
						<div class="meta-row"><span class="meta-key">파일명</span><span class="meta-val">등록된 파일 없음</span>
						</div>
						<div class="meta-row"><span class="meta-key">약관</span><span class="meta-val">업로드 전</span></div>
					</div>
				</div>
			</section>

			<!-- 하단 액션 -->
			<div class="form-actions">
				<a th:href="@{/admin/product}" class="btn back">이전</a>
				<div class="form-actions__right">
					<button type="button" class="btn">임시 저장</button>
					<button type="submit" class="btn btn--primary">등록</button>
				</div>
			</div>

			<!-- 결과화면 임시-->
			 
			<div id="result" style="margin-top: 20px; font-weight: bold;"></div>
		</form>

		<script>
			function addCoverage() {
				const tpl = document.getElementById("coverage-template");
				const clone = tpl.content.cloneNode(true);
				document.getElementById("coverage-list").appendChild(clone);
			}

			function addRate() {
				const tpl = document.getElementById("rate-template");
				const clone = tpl.content.cloneNode(true);
				document.getElementById("rate-list").appendChild(clone);
			}

			document.getElementById("insurance-form").addEventListener("submit", function (e) {
				e.preventDefault();

				const form = e.target;
				const formData = new FormData();

				// 상품 정보
				formData.append("product_name", form.product_name.value);
				formData.append("product_desc", form.product_desc.value);
				formData.append("thumbnail", form.thumbnail.files[0]);
				formData.append("conditions", form.conditions.files[0]);

				// 담보
				const coverages = [];
				document.querySelectorAll(".coverage-row").forEach(row => {
					coverages.push({
						cover_name: row.querySelector(".cover-name").value,
						cover_desc: row.querySelector(".cover-desc").value,
						coverage_amount: parseFloat(row.querySelector(".cover-amount").value) || 0,
						base_premium: parseFloat(row.querySelector(".cover-premium").value) || 0,
						cover_required: row.querySelector(".cover-required").value
					});
				});

				// 요율
				const rates = [];
				document.querySelectorAll(".rate-row").forEach(row => {
					rates.push({
						age_from: parseInt(row.querySelector(".age-from").value),
						age_to: parseInt(row.querySelector(".age-to").value),
						gender: row.querySelector(".gender").value,
						is_smoker: row.querySelector(".smoker").checked,
						age_weight: parseFloat(row.querySelector(".age-weight").value) || 0.5,
						gender_weight: parseFloat(row.querySelector(".gender-weight").value) || 0.1
					});
				});

				// JSON 데이터 추가
				const jsonData = {
					coverages,
					premiumRates: rates
				};
				formData.append("productJson", new Blob([JSON.stringify(jsonData)], { type: 'application/json' }));

				// Ajax 전송
				fetch('/api/products', {
					method: 'POST',
					body: formData
				})
					.then(res => res.ok ? res.json() : Promise.reject(res))
					.then(data => {
						document.getElementById("result").textContent = "✅ 등록 성공!";
						form.reset();
						document.getElementById("coverage-list").innerHTML = "";
						document.getElementById("rate-list").innerHTML = "";
					})
					.catch(err => {
						document.getElementById("result").textContent = "❌ 등록 실패. 다시 시도하세요.";
					});
			});
		</script>

	</main>


</body>

</html>